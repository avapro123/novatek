# Novatek Power Meter (EM-129) Integration for Home Assistant

Эта пользовательская интеграция для Home Assistant позволяет считывать данные с приборов серии **Novatek** (например, EM-129) через Web API. Данная интеграция реализована на Python и полностью адаптирована для работы с **Home Assistant Core 2025.4.0**, Supervisor 2025.03.4 и Operating System 14.1.

## Основа проекта

Интеграция базируется на оригинальном проекте [vedga/novatek](https://github.com/vedga/novatek). Основная идея и некоторые части реализации (авторизация, получение данных по API) были взяты из этого проекта и доработаны под новые требования Home Assistant, включая поддержку config_flow, Update Coordinator и асинхронный код.

## Функционал

- **Авторизация и сессия.**  
  Интеграция подключается к устройству по HTTP. Сначала запрашиваются базовые сведения об устройстве и SALT для хэширования пароля. Хэш формируется по формуле:  
  `hash = sha1(model + password + salt)`  
  При успешном входе сохраняется SID сессии. При остановке Home Assistant выполняется Logout для освобождения сессии.

- **Получение данных.**  
  Интеграция запрашивает с устройства следующие параметры:
  - **Напряжение** (API возвращает значение в V*10; результат делится на 10)
  - **Ток** (API возвращает значение в A*100; результат делится на 100)
  - **Частота** (API возвращает значение в Hz*100; результат делится на 100)
  - **Активная мощность** (W)
  - **Полная (апп.) мощность** (W)
  - **Активная энергия** (Wh)
  - **Полная энергия** (Wh)
  
  Все данные объединяются в единый словарь и периодически обновляются с использованием `DataUpdateCoordinator`.

- **Настройка через Config Flow.**  
  Интеграция использует динамический процесс настройки через пользовательский интерфейс Home Assistant. При добавлении интеграции пользователь вводит IP-адрес (или host) прибора, пароль и (опционально) произвольное имя.

- **Опрос с настраиваемым интервалом.**  
  Интервал обновления данных можно задавать в настройках интеграции (по умолчанию — 30 секунд).

- **Сенсоры Home Assistant.**  
  После успешного подключения создаются сенсоры для каждого параметра. Названия и единицы измерения задаются через шаблоны, что позволяет использовать стандартные визуальные средства Home Assistant для отображения данных (например, на карточках Lovelace).

## Инструкция по установке

1. **Подготовка файлов интеграции.**  
   Склонируйте или скачайте данный репозиторий и убедитесь, что структура каталогов выглядит следующим образом:
   
custom_components/ 
  └── novatek/ 
  ├── init.py 
  ├── manifest.json 
  ├── config_flow.py 
  ├── novatek_api.py 
  └── sensor.py
  
2. **Копирование в Home Assistant.**  
Скопируйте папку `novatek` в каталог `custom_components` вашего конфигурационного каталога Home Assistant (обычно `/config/custom_components/`).

3. **Перезапуск Home Assistant.**  
Перезагрузите Home Assistant для обнаружения новой интеграции.

4. **Добавление интеграции через UI.**  
- Зайдите в **Настройки** → **Устройства и службы**.
- Нажмите **Добавить интеграцию**.
- Найдите интеграцию **Novatek Power Meter** (или похожее название) и выберите её.
- Введите необходимые параметры:
  - **Host:** IP-адрес или доменное имя вашего прибора (например, `192.168.0.100`).
  - **Password:** пароль для доступа к Web API прибора.
  - **Name:** (опционально) произвольное имя для удобного идентифицирования устройства.
- Подтвердите настройку.

5. **Проверка работы.**  
После успешного добавления интеграции Home Assistant создаст сенсоры для каждого параметра (напряжение, ток, частота, активная/полная мощность, активная/полная энергия). Проверьте состояние сенсоров через **Инструментарий разработчика** → **Состояния** или на карточке в интерфейсе.

6. **Настройка интервала опроса (опционально).**  
Если требуется изменить интервал обновления (по умолчанию — 30 секунд), откройте настройки интеграции и установите нужное значение для параметра "scan_interval" (в секундах).

7. **Примечание по сессии.**  
Учтите, что прибор поддерживает только одну активную сессию одновременно. Если вы одновременно используете веб-интерфейс прибора и Home Assistant, могут возникать конфликты. Интеграция автоматически выполняет logout при остановке Home Assistant.

## Пример вывода времени последнего обновления

Для отображения времени, прошедшего с момента последнего обновления параметра напряжения, можно создать дополнительный шаблонный сенсор. Пример для файла `configuration.yaml`:

```yaml
template:
- sensor:
   - name: "Время с последнего обновления напряжения"
     unique_id: "vira_power_voltage_update_time"
     icon: "mdi:clock-outline"
     state: >
       {% if states.sensor.vira_power_voltage.last_updated %}
         {% set diff = as_timestamp(now()) - as_timestamp(states.sensor.vira_power_voltage.last_updated) %}
         {% set minutes = (diff // 60) | int %}
         {% set seconds = (diff % 60) | int %}
         {% if minutes > 0 %}
           {{ minutes }} мин {{ seconds }} сек назад
         {% else %}
           {{ seconds }} сек назад
         {% endif %}
       {% else %}
         Нет данных
       {% endif %}
